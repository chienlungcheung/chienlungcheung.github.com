<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Leveldb 源码详解系列之八: 版本(Version) - 二手知识</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3CREWXCLR7"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3CREWXCLR7")</script><meta name=Description content><meta property="og:title" content="Leveldb 源码详解系列之八: 版本(Version)"><meta property="og:description" content="Version 是 leveldb 在磁盘上的文件 level 结构的抽象, 也是访问磁盘文件的隘口. 也就是说, 要读取磁盘上的文件, 必须要经过 Version. 要针对磁盘上的数据库做一些优化或者统计,"><meta property="og:type" content="article"><meta property="og:url" content="https://chienlungcheung.github.io/leveldb-annotations-8-versions/"><meta property="og:image" content="https://chienlungcheung.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-18T01:22:28+08:00"><meta property="article:modified_time" content="2022-06-18T01:22:28+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://chienlungcheung.github.io/logo.png"><meta name=twitter:title content="Leveldb 源码详解系列之八: 版本(Version)"><meta name=twitter:description content="Version 是 leveldb 在磁盘上的文件 level 结构的抽象, 也是访问磁盘文件的隘口. 也就是说, 要读取磁盘上的文件, 必须要经过 Version. 要针对磁盘上的数据库做一些优化或者统计,"><meta name=twitter:site content="@haricheung"><meta name=application-name content="DoIt"><meta name=apple-mobile-web-app-title content="DoIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://chienlungcheung.github.io/leveldb-annotations-8-versions/><link rel=prev href=https://chienlungcheung.github.io/lsmtree-paper/><link rel=next href=https://chienlungcheung.github.io/consistent-protocol-of-nacos-part-1/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Leveldb 源码详解系列之八: 版本(Version)","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/chienlungcheung.github.io\/leveldb-annotations-8-versions\/"},"genre":"posts","keywords":"leveldb, LSM-Tree, db, kv","wordcount":1724,"url":"https:\/\/chienlungcheung.github.io\/leveldb-annotations-8-versions\/","datePublished":"2022-06-18T01:22:28+08:00","dateModified":"2022-06-18T01:22:28+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Hari"},"description":""}</script><script src=//instant.page/5.1.1 defer type=module integrity=sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq></script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=二手知识>二手知识</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=# class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=# class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=# class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=二手知识>二手知识</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=# class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=# class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=# class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=# class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#1-version-用途>1. Version 用途</a><ul><li><a href=#11-一个读取例子>1.1 一个读取例子</a></li><li><a href=#12-一个写例子>1.2 一个写例子</a></li></ul></li><li><a href=#2-version-构造>2. Version 构造</a></li><li><a href=#3-version-增量更新>3. Version 增量更新</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Leveldb 源码详解系列之八: 版本(Version)</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=/ title=Author rel=author class=author>Hari</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-06-18>2022-06-18</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2022-06-18>2022-06-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1724 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-version-用途>1. Version 用途</a><ul><li><a href=#11-一个读取例子>1.1 一个读取例子</a></li><li><a href=#12-一个写例子>1.2 一个写例子</a></li></ul></li><li><a href=#2-version-构造>2. Version 构造</a></li><li><a href=#3-version-增量更新>3. Version 增量更新</a></li></ul></nav></div></div><div class=content id=content><p><code>Version</code> 是 leveldb 在磁盘上的文件 level 结构的抽象, 也是访问磁盘文件的隘口. 也就是说, 要读取磁盘上的文件, 必须要经过 <code>Version</code>. 要针对磁盘上的数据库做一些优化或者统计, 也可以通过 <code>Version</code> 来实现.</p><h2 id=1-version-用途 class=headerLink><a href=#1-version-%e7%94%a8%e9%80%94 class=header-mark></a>1. Version 用途</h2><p>下面通过读写来了解下 <code>Version</code> 的作用.</p><h3 id=11-一个读取例子 class=headerLink><a href=#11-%e4%b8%80%e4%b8%aa%e8%af%bb%e5%8f%96%e4%be%8b%e5%ad%90 class=header-mark></a>1.1 一个读取例子</h3><p>被用户高频使用的 <code>DBImpl::Get</code> 方法就会用到 <code>Version</code>. 当在内存中的 memtables 找不到 key 时, 就需要去查询文件. 此时, 当前 <code>Version</code> 开始起作用.</p><p>下面代码删掉了与我们这里要介绍内容关联不大的部分.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Status</span> <span class=n>DBImpl</span><span class=o>::</span><span class=n>Get</span><span class=p>(</span><span class=k>const</span> <span class=n>ReadOptions</span><span class=o>&amp;</span> <span class=n>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=k>const</span> <span class=n>Slice</span><span class=o>&amp;</span> <span class=n>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>*</span> <span class=n>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=n>have_stat_update</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Version</span><span class=o>::</span><span class=n>GetStats</span> <span class=n>stats</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 根据 user_key 和快照对应的序列号构造一个 internal_key
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>LookupKey</span> <span class=nf>lkey</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>snapshot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 先查询内存中与当前 log 文件对应的 memtable
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>mem</span><span class=o>-&gt;</span><span class=n>Get</span><span class=p>(</span><span class=n>lkey</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=n>imm</span> <span class=o>!=</span> <span class=k>nullptr</span> <span class=o>&amp;&amp;</span> <span class=n>imm</span><span class=o>-&gt;</span><span class=n>Get</span><span class=p>(</span><span class=n>lkey</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 查不到来待压实的 memtable 去查询
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 查不到再逐 level 去 sstable 文件查找, 这时候就用到了 Version current
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>s</span> <span class=o>=</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>Get</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>lkey</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>stats</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>have_stat_update</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 每次查询完都要检查下是否有文件查询次数已经达到最大需要进行压实了.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>have_stat_update</span> <span class=o>&amp;&amp;</span> <span class=n>current</span><span class=o>-&gt;</span><span class=n>UpdateStats</span><span class=p>(</span><span class=n>stats</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>MaybeScheduleCompaction</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面 <code>current</code> 就是当前 <code>Version</code>.</p><p>方法末尾的判断目的是记录本次扫盘对压实施加的影响, 如果最底层文件读取次数超出上限则进行压实, 关于压实请看之前文章介绍.</p><h3 id=12-一个写例子 class=headerLink><a href=#12-%e4%b8%80%e4%b8%aa%e5%86%99%e4%be%8b%e5%ad%90 class=header-mark></a>1.2 一个写例子</h3><p>没有. leveldb 文件一旦落盘便不可更改.</p><h2 id=2-version-构造 class=headerLink><a href=#2-version-%e6%9e%84%e9%80%a0 class=header-mark></a>2. Version 构造</h2><p><code>Version</code> 不单独存在, 由 <code>VersionSet</code> 负责维护.</p><p>leveldb 在启动时会构造一个 <code>VerionSet</code>, 后者会读取磁盘上的 MANIFEST 文件构造 <code>Version</code>.</p><p>leveldb 在打开数据库时会调用 <code>Recover()</code> 读取磁盘上的文件, 其中就有构造 <code>Version</code> 所需要的 MANIFEST 文件:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Status</span> <span class=n>DB</span><span class=o>::</span><span class=n>Open</span><span class=p>(</span><span class=k>const</span> <span class=n>Options</span><span class=o>&amp;</span> <span class=n>options</span><span class=p>,</span> <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span> <span class=n>dbname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>DB</span><span class=o>**</span> <span class=n>dbptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 读取 current 文件, manifest 文件, sstable 文件和 log 文件恢复数据库.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 如果要打开的数据库不存在, Recover 负责进行创建.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Status</span> <span class=n>s</span> <span class=o>=</span> <span class=n>impl</span><span class=o>-&gt;</span><span class=n>Recover</span><span class=p>(</span><span class=o>&amp;</span><span class=n>edit</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>save_manifest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>impl->Recover</code> 做相关工作调用的是 <code>VersionSet</code> 的对应方法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>Status</span> <span class=n>DBImpl</span><span class=o>::</span><span class=n>Recover</span><span class=p>(</span><span class=n>VersionEdit</span><span class=o>*</span> <span class=n>edit</span><span class=p>,</span> <span class=kt>bool</span> <span class=o>*</span><span class=n>save_manifest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 该方法负责从最后一个 MANIFEST 文件解析内容出来与当前 Version
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 保存的 level 架构合并保存到一个
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 新建的 Version 中, 然后将这个新的 version 作为当前的 version.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 参数是输出型的, 负责保存一个指示当前 MANIFEST 文件是否可以续用.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>s</span> <span class=o>=</span> <span class=n>versions_</span><span class=o>-&gt;</span><span class=n>Recover</span><span class=p>(</span><span class=n>save_manifest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>VersionSet::Recover()</code> 解析 MANIFEST 文件每一行, 反序列化为 <code>VersionEdit</code>, 然后将其组装为其当前 <code>Version</code> 即 <code>current_</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// 该方法负责从最后一个 MANIFEST 文件解析内容出来与当前 Version 
</span></span></span><span class=line><span class=cl><span class=c1>// 保存的 level 架构合并保存到一个
</span></span></span><span class=line><span class=cl><span class=c1>// 新建的 Version 中, 然后将这个新的 version 作为当前的 version.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Status</span> <span class=n>VersionSet</span><span class=o>::</span><span class=n>Recover</span><span class=p>(</span><span class=kt>bool</span> <span class=o>*</span><span class=n>save_manifest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 读取 CURRENT 文件获取 MANIFEST 文件名称
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Status</span> <span class=n>s</span> <span class=o>=</span> <span class=n>ReadFileToString</span><span class=p>(</span><span class=n>env_</span><span class=p>,</span> <span class=n>CurrentFileName</span><span class=p>(</span><span class=n>dbname_</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 构造 MANIFEST 文件路径
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>dscname</span> <span class=o>=</span> <span class=n>dbname_</span> <span class=o>+</span> <span class=s>&#34;/&#34;</span> <span class=o>+</span> <span class=n>current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>SequentialFile</span><span class=o>*</span> <span class=n>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>s</span> <span class=o>=</span> <span class=n>env_</span><span class=o>-&gt;</span><span class=n>NewSequentialFile</span><span class=p>(</span><span class=n>dscname</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 解析 MANIFEST 文件内容反序列化为 VersionEdit
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Builder</span> <span class=nf>builder</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>current_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>::</span><span class=n>Reader</span> <span class=n>reader</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>reporter</span><span class=p>,</span> <span class=nb>true</span><span class=cm>/*checksum*/</span><span class=p>,</span> <span class=mi>0</span><span class=cm>/*initial_offset*/</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 循环读取 MANIFEST 文件日志, 每一行日志就是一个 VersionEdit
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=n>reader</span><span class=p>.</span><span class=n>ReadRecord</span><span class=p>(</span><span class=o>&amp;</span><span class=n>record</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>scratch</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>s</span><span class=p>.</span><span class=n>ok</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>VersionEdit</span> <span class=n>edit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 将 record 反序列化为 version_edit
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>s</span> <span class=o>=</span> <span class=n>edit</span><span class=p>.</span><span class=n>DecodeFrom</span><span class=p>(</span><span class=n>record</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// 将 VersionEdit 保存到 VersionSet 的 builder 中, 
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 后者可以一次性将这些文件变更与当前 Version 合并构成新 version.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=n>ok</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=p>.</span><span class=n>Apply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>edit</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 至此解析 MANIFEST 文件结束, 根据其保存的全部文件变更创建新的 Version
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=n>ok</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Version</span><span class=o>*</span> <span class=n>v</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Version</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将当前 version 和 builder 的 level 架构合并放到新的 v 中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>SaveTo</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将 v 作为当前 version
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>AppendVersion</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>至此, leveldb 的 <code>Version</code> 构造完成.</p><h2 id=3-version-增量更新 class=headerLink><a href=#3-version-%e5%a2%9e%e9%87%8f%e6%9b%b4%e6%96%b0 class=header-mark></a>3. Version 增量更新</h2><p>每当有文件变更时(这一般由普通写操作和压实操作触发), 相关变更(如文件新增或删除)会被记录到 <code>VersionEdit</code>. <code>VersionEdit</code> 可以看作一个 on-fly 的 Version. 它会记录 db 运行过程中删除的文件列表和新增的文件列表. <code>VersionSet</code> 会将新的 <code>VersionEdit</code> 与当前 <code>Version</code> 合并构造一个新的 <code>Version</code> 服务于 leveldb 用户. <code>VersionEdit</code> 可以看作是 <code>Version</code> 的增量更新, <code>全量+增量=新全量</code>.</p><p>具体代码如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// 1, 将参数 *edit 内容(可看作当前针对 level 架构的增量更新)
</span></span></span><span class=line><span class=cl><span class=c1>// 和当前 version 内容合并构成一个新的 version;
</span></span></span><span class=line><span class=cl><span class=c1>// 2, 然后将这个新 version 内容序列化为一条日志写到新建的 manifest 文件;
</span></span></span><span class=line><span class=cl><span class=c1>// 3, 同时将该 manifest 文件名写入 current 文件;
</span></span></span><span class=line><span class=cl><span class=c1>// 4, 最后把新的 version 替换当前 version.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Status</span> <span class=n>VersionSet</span><span class=o>::</span><span class=n>LogAndApply</span><span class=p>(</span><span class=n>VersionEdit</span><span class=o>*</span> <span class=n>edit</span><span class=p>,</span> <span class=n>port</span><span class=o>::</span><span class=n>Mutex</span><span class=o>*</span> <span class=n>mu</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 新建一个 Version 用于合并当前 Version 和 VersionEdit 保存的增量更新
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Version</span><span class=o>*</span> <span class=n>v</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Version</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将当前 VersionSet 及其 current version 作为输入构建一个新的 Builder
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Builder</span> <span class=nf>builder</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>current_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将新的 VersionEdit 与 current version 内容合并
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>Apply</span><span class=p>(</span><span class=n>edit</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将 Builder 内容输出到 Version v 中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>builder</span><span class=p>.</span><span class=n>SaveTo</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Initialize new descriptor log file if necessary by creating
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// a temporary file that contains a snapshot of the current version.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 如有必要通过创建一个临时文件来初始化一个新的文件描述符, 这个临时文件包含了当前 Version 的一个快照
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>new_manifest_file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Status</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 MANIFEST 文件指针为空则新建一个
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>descriptor_log_</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// manifest 文件又叫 descriptor 文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>s</span> <span class=o>=</span> <span class=n>env_</span><span class=o>-&gt;</span><span class=n>NewWritableFile</span><span class=p>(</span><span class=n>new_manifest_file</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>descriptor_file_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=n>ok</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>descriptor_log_</span> <span class=o>=</span> <span class=k>new</span> <span class=n>log</span><span class=o>::</span><span class=n>Writer</span><span class=p>(</span><span class=n>descriptor_file_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 将当前 Version 保存的 level 架构信息保存到一个新 VersionEdit 
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 中后将其序列化到 MANIFEST 文件.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>s</span> <span class=o>=</span> <span class=n>WriteSnapshot</span><span class=p>(</span><span class=n>descriptor_log_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Unlock during expensive MANIFEST log write
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mu</span><span class=o>-&gt;</span><span class=n>Unlock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将通过参数传入的 VersionEdit 记录到 manifest 文件. 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 这个地方相对于上面的 snapshot 相当于是一个增量.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=n>ok</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>edit</span><span class=o>-&gt;</span><span class=n>EncodeTo</span><span class=p>(</span><span class=o>&amp;</span><span class=n>record</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>s</span> <span class=o>=</span> <span class=n>descriptor_log_</span><span class=o>-&gt;</span><span class=n>AddRecord</span><span class=p>(</span><span class=n>record</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mu</span><span class=o>-&gt;</span><span class=n>Lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 将基于当前 Version 和增量 VersionEdit 构建的新 version 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 作为当前 version. 它是最新的 level 架构.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>AppendVersion</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>&mdash;end&mdash;</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-06-18</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/leveldb-annotations-8-versions/index.md target=_blank rel="noopener noreferrer">阅读原始文档</a></span></div><div class=post-info-share><span><a href=# title="分享到 Twitter" data-sharer=twitter data-url=https://chienlungcheung.github.io/leveldb-annotations-8-versions/ data-title="Leveldb 源码详解系列之八: 版本(Version)" data-via=haricheung data-hashtags=leveldb,LSM-Tree,db,kv><i class="fab fa-twitter fa-fw"></i></a><a href=# title="分享到 Facebook" data-sharer=facebook data-url=https://chienlungcheung.github.io/leveldb-annotations-8-versions/ data-hashtag=leveldb><i class="fab fa-facebook-square fa-fw"></i></a><a href=# title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://chienlungcheung.github.io/leveldb-annotations-8-versions/ data-title="Leveldb 源码详解系列之八: 版本(Version)" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=# title="分享到 Line" data-sharer=line data-url=https://chienlungcheung.github.io/leveldb-annotations-8-versions/ data-title="Leveldb 源码详解系列之八: 版本(Version)"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a><a href=# title="分享到 微博" data-sharer=weibo data-url=https://chienlungcheung.github.io/leveldb-annotations-8-versions/ data-title="Leveldb 源码详解系列之八: 版本(Version)"><i class="fab fa-weibo fa-fw"></i></a><a href=# title="分享到 Myspace" data-sharer=myspace data-url=https://chienlungcheung.github.io/leveldb-annotations-8-versions/ data-title="Leveldb 源码详解系列之八: 版本(Version)" data-description><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a><a href=# title="分享到 Blogger" data-sharer=blogger data-url=https://chienlungcheung.github.io/leveldb-annotations-8-versions/ data-title="Leveldb 源码详解系列之八: 版本(Version)" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=# title="分享到 Evernote" data-sharer=evernote data-url=https://chienlungcheung.github.io/leveldb-annotations-8-versions/ data-title="Leveldb 源码详解系列之八: 版本(Version)"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/leveldb/>leveldb</a>,&nbsp;<a href=/tags/lsm-tree/>LSM-Tree</a>,&nbsp;<a href=/tags/db/>db</a>,&nbsp;<a href=/tags/kv/>kv</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/lsmtree-paper/ class=prev rel=prev title="LSM-Tree 论文阅读笔记"><i class="fas fa-angle-left fa-fw"></i>LSM-Tree 论文阅读笔记</a>
<a href=/consistent-protocol-of-nacos-part-1/ class=next rel=next title="Nacos 的一致性存储解析--Distro 篇">Nacos 的一致性存储解析--Distro 篇<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.120.1">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">Hari</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},sharerjs:!0,table:{sort:!0}}</script><script type=text/javascript src=https://Chienlung.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script></div></body></html>